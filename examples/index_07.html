<!DOCTYPE html>
<html lang="en">

<head>
<title>algo.js examples: </title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
body {
  margin: 0;
  padding: 0;
  font-size: 0;
  background-color: #000000;
}

canvas {
  width: 100%;
  height: 100%;
}
</style>
</head>

<body>
<canvas id="canvas"></canvas>
<script type="text/javascript" src="../build/algo.js"></script>
<!-- <script type="text/javascript" src="../src/algo.js"></script> -->
<script type="text/javascript" src="assets/js/libs/dat.gui.min.js"></script>
<script type="text/javascript" src="assets/js/libs/stats.min.js"></script>
<script type="text/javascript">
var stats = new Stats();
var param = {
  id: 'canvas',
  width: window.innerWidth,
  height: window.innerHeight
};
var algo = new ALGO(param);
algo.width = window.innerWidth;
algo.height = window.innerHeight;
algo.background = 0x000000;
algo.backgroundAuto = true;
algo.backgroundAlpha = 0.8;
algo.framerate = 60;
algo.circleResolution = 20;
algo.blendMode = ALGO.BLEND_ALPHA;

ALGO.log(algo);

var geometry_num = 10000;
var map1, map2, map3;
var step = 8;
var noise;
var pattern = [];
var geometry = [];
var mx;
var my;

function getNoiseMap(){
  var aw = algo.width;
  var ah = algo.height;
  ALGO.log( aw + ', ' + ah );
  var map = [];
  noise.seed(Math.random());
  for (var xi = 0; xi < aw; xi += step) {
    map[xi] = [];
    for (var yi = 0; yi < ah; yi += step) {
      var value = noise.perlin2(xi / 100, yi / 100);
      // var grayscale = Math.abs(value) * 256 - 128;
      var grayscale = value *  128;
      map[xi][yi] = grayscale;
    }
  }
  // ALGO.log( map );
  return map;
}

algo.bind('setup', function() {
  var aw = algo.width;
  var ah = algo.height;

  map1 = getNoiseMap();
  map2 = getNoiseMap();
  map3 = getNoiseMap();

  particles = new ALGO.Particle( 0, 0 );
  for (var xi = 0; xi < aw; xi += step) {
    for (var yi = 0; yi < ah; yi += step) {
      var vec = {
        x: xi,
        y: yi,
        ax: 0,
        ay: 0,
        vx: 0,
        vy: 0
      };
      geometry.push( vec );
    }
  }
  ALGO.log('length: ' + geometry.length);
  particles.setGeometry( geometry );
  particles.pointsize = 1.2;
  particles.color = 0xffffff;
  algo.add(particles);

  // stats
  stats.domElement.style.position = 'fixed';
  stats.domElement.style.right = '0px';
  stats.domElement.style.top = '0px';
  document.body.appendChild(stats.domElement);
});

algo.bind('frame', function() {
  var aw = algo.width;
  var ah = algo.height;

  var length = geometry.length;
  for( var i = 0; i < length; i++ ){
    var g = geometry[i];
    var stepx = Math.floor(g.x / step) * step;
    var stepy = Math.floor(g.y / step) * step;
    var map1_value = map1[ stepx ][ stepy ];
    var map2_value = map2[ stepx ][ stepy ];

    if( i == 0 ){
      // ALGO.log( Math.floor(g.x / step) + ', ' + Math.floor(g.y / step) );
      // ALGO.log( stepx + '/' + aw + ', ' + stepy + '/' + ah );
      // ALGO.log(map1_value + ', ' + map2_value );
      // ALGO.log(map1 );
    }

    // out of window
    if( map1_value == undefined ) map1_value = 0;
    if( map2_value == undefined ) map2_value = 0;

    g.ax += map1_value * 0.00005;
    g.ay += map2_value * 0.00005;
    g.vx += g.ax;
    g.vy += g.ay;
    g.x += g.vx;
    g.y += g.vy;

    g.rotation = Math.atan2( g.vy, g.vx ) * 180 / Math.PI;

    g.ax *= .96;
    g.ay *= .96;
    g.vx *= .92;
    g.vy *= .92;

    ( g.x > aw ) ? g.x = 0 : ( g.x < 0 ) ? g.x = aw : 0;
    ( g.y > ah ) ? g.y = 0 : ( g.y < 0 ) ? g.y = ah : 0;

  }
  particles.setGeometry( geometry );
  particles.vertexUpdate();

  particles.needsUpdate = true;

  // stats
  stats.update();
});

algo.bind('mousemove', function( mousex, mousey ) {
  mx = mousex;
  my = mousey;
  // path.lineTo( mx, my );
});

algo.bind('mousedown', function( mousex, mousey ) {
  // path.clear();
});

algo.bind('resize', function() {
  // ALGO.log('resize after');
  var w = window.innerWidth;
  var h = window.innerHeight;
  algo.size(w, h);
});
</script>
</body>

</html>
